<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>ğŸŒ± ESG å°è©±æŸ¥è©¢æ©Ÿå™¨äºº</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    body { font-family:"Noto Sans TC",sans-serif; background:#f7f9fb; display:flex; justify-content:center; align-items:center; height:100vh; margin:0; }
    .layout { display:flex; width:900px; height:620px; background:#fff; border-radius:16px; box-shadow:0 2px 12px rgba(0,0,0,.1); overflow:hidden; }
    .sidebar { width:260px; background:#f1f3f5; border-right:1px solid #e6e6e6; display:flex; flex-direction:column; }
    .sidebar h3 { margin:12px; font-size:1em; }
    .sidebar .row { display:flex; gap:8px; align-items:center; padding:0 12px 8px; }
    .sidebar button, .toolbar button, .input-area button { padding:6px 12px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer; }
    .sidebar button.newchat { background:#0078ff; color:#fff; border-color:#0078ff; }
    .chat-list { flex:1; overflow-y:auto; padding:6px; }
    .chat-item { padding:8px 10px; border-radius:8px; margin:6px; background:#fff; border:1px solid transparent; cursor:pointer; }
    .chat-item.active { background:#0078ff; color:#fff; }
    .chat-item .sub { display:block; font-size:.82em; opacity:.8; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .chat-container { flex:1; display:flex; flex-direction:column; }
    .toolbar { display:flex; gap:8px; padding:10px; border-bottom:1px solid #eee; justify-content:center; background:#fafafa; position:relative; }
    .toolbar button.active { background:#0078ff; color:#fff; border-color:#0078ff; }
    .toolbar .right-tools { position:absolute; right:10px; top:8px; display:flex; gap:8px; }
    .chat-box { flex:1; padding:15px; overflow-y:auto; }
    .message { margin:10px 0; padding:10px 14px; border-radius:12px; max-width:80%; line-height:1.5; }
    .user { background:#0078ff; color:white; align-self:flex-end; border-bottom-right-radius:2px; white-space: pre-wrap;}
    .bot { background:#e5e7eb; color:#222; align-self:flex-start; border-bottom-left-radius:2px; white-space: normal; }
    .bot h1,.bot h2,.bot h3,.bot h4 { margin:.4em 0 .25em; line-height:1.25; font-size:1.05em; font-weight:600;}
    .bot p { margin:.35em 0;}
    .bot ul,.bot ol { margin:.35em 0 .35em 1.2em; padding:0;}
    .bot li { margin:.2em 0;}
    .bot pre { margin:.35em 0; padding:.5em; background:#f5f7fa; border-radius:8px; overflow:auto;}
    .source { font-size:0.85em; color:#666; margin-top:4px; }
    .input-area { display:flex; padding:10px; border-top:1px solid #ddd; }
    input { flex:1; padding:10px; border:1px solid #ccc; border-radius:8px; outline:none; }
    button.send { background:#0078ff; color:white; border:none; border-radius:8px; padding:0 16px; margin-left:8px; cursor:pointer; }
    button.send:hover { background:#0062d9; }

    /* Modalï¼ˆé¸å–è¦ç¸½æ•´çš„å°è©±ï¼‰ */
    .modal { position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; z-index:9999; backdrop-filter:blur(2px); }
    .modal .panel { width:520px; max-height:70vh; overflow:auto; background:#fff; border-radius:12px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.2); }
    .modal h4 { margin:0 0 8px; }
    .modal .list { display:flex; flex-direction:column; gap:8px; margin:12px 0; padding:0 4px; }
    .modal .list label { display:flex; align-items:center; gap:8px; justify-content:flex-start; font-size:14px; }
    .modal .actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
    .modal .actions .busy { opacity:.6; pointer-events:none; }

    /* Toastï¼ˆæ‡¸æµ®æç¤ºï¼Œä¸å¹²æ“¾èŠå¤©å€ï¼‰ */
    .toast { position:fixed; top:16px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,.82); color:#fff; padding:10px 14px; border-radius:10px; font-size:14px; box-shadow:0 10px 30px rgba(0,0,0,.25); z-index:10050; display:none; align-items:center; gap:10px; }
    .toast.show { display:flex; }
    .spinner { width:16px; height:16px; border:2px solid rgba(255,255,255,.35); border-top-color:#fff; border-radius:50%; animation:spin 0.9s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg);} }

  </style>
</head>
<body>
  <div class="layout">
    <!-- å·¦å´ï¼šå°è©±åˆ—è¡¨ -->
    <div class="sidebar">
      <h3>å°è©±åˆ—è¡¨</h3>
      <div class="row">
        <button class="newchat" onclick="newChat()">ï¼‹ æ–°å°è©±</button>
        <button onclick="deleteChat()">åˆªé™¤</button>
      </div>
      <div id="chat-list" class="chat-list"></div>
    </div>

    <!-- å³å´ï¼šèŠå¤©å€ -->
    <div class="chat-container">
      <div class="toolbar">
        <button id="btn-all"  class="active" onclick="setMode('all')">å…¨éƒ¨</button>
        <button id="btn-esg"  onclick="setMode('esg')">æ•¸æ“šï¼ˆESGï¼‰</button>
        <button id="btn-news" onclick="setMode('news')">è³‡è¨Šï¼ˆNEWSï¼‰</button>
        <button id="btn-summary" onclick="openSummaryModal()">ç¸½æ•´</button>

        <!-- åªåœ¨ã€Œç¸½æ•´ç”¢ç”Ÿçš„å°è©±ã€é¡¯ç¤º -->
        <div class="right-tools">
          <button id="btn-download" onclick="downloadSummaryContentPDF()" style="display:none">ä¸‹è¼‰ PDF</button>
        </div>
      </div>

      <div class="chat-box" id="chat-box">
        <div class="message bot">è«‹è¼¸å…¥å•é¡Œï¼Œä¸Šæ–¹å¯åˆ‡æ›æŸ¥è©¢é¡å‹ï¼ˆå…¨éƒ¨ / æ•¸æ“š / è³‡è¨Šï¼‰ã€‚</div>
      </div>

      <div class="input-area">
        <input id="user-input" type="text" placeholder="è¼¸å…¥æ‚¨çš„å•é¡Œ..." />
        <button class="send" id="send-btn" onclick="sendMessage()">é€å‡º</button>
      </div>
    </div>
  </div>

  <!-- ç¸½æ•´ Modalï¼ˆå‹¾é¸è¦ç¸½çµçš„å°è©±ï¼‰ -->
  <div id="summary-modal" class="modal">
    <div class="panel">
      <h4>é¸æ“‡è¦ç¸½çµçš„å°è©±</h4>
      <div id="summary-list" class="list"></div>
      <div class="actions">
        <button id="btn-cancel-sum" onclick="closeSummaryModal()">å–æ¶ˆ</button>
        <button id="btn-do-sum" onclick="summarizeSelected()">ç”Ÿæˆç¸½çµ</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="app-toast" class="toast"><div class="spinner"></div><span id="toast-text">è™•ç†ä¸­â€¦</span></div>

<script>
  // ===== API =====
  const API_URL   = "http://127.0.0.1:8000/query";
  const TITLE_API = "http://127.0.0.1:8000/title";
  const SUM_API   = "http://127.0.0.1:8000/summarize";

  // ===== ç‹€æ…‹ =====
  const chatBox   = document.getElementById("chat-box");
  const userInput = document.getElementById("user-input");
  const sendBtn   = document.getElementById("send-btn");
  const dlBtn     = document.getElementById("btn-download");
  let mode = "all";

  // æ”¹é€™è¡Œï¼šé—œé–‰åˆ†é å°±æ¸…ç©º â†’ ä½¿ç”¨ sessionStorageï¼›è‹¥è¦æ°¸ä¹…ä¿å­˜æ”¹å› localStorage
  let storage = window.localStorage;

  // chats: { id: {title, history: [[user,bot,sources], ...], isSummary?: true } }
  let chats = JSON.parse(storage.getItem("esg_chats") || '{"chats":{}}').chats;
  let currentChatId = null;
  let isSummarizing = false; // é˜²é€£é»

  // ===== å·¥å…· =====
  function uuid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36); }
  function saveChats(){ storage.setItem("esg_chats", JSON.stringify({chats})); }
  function normalizeMd(md){ return (md || "").replace(/\r\n/g,"\n").replace(/\n{3,}/g,"\n\n").trim(); }
  function fmtNow(){
    const d = new Date();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    const HH = String(d.getHours()).padStart(2,"0");
    const MM = String(d.getMinutes()).padStart(2,"0");
    return `${d.getFullYear()}/${mm}/${dd} ${HH}:${MM}`;
  }

  // Toast
  function showToast(text, withSpinner=true){
    const t = document.getElementById("app-toast");
    const s = t.querySelector(".spinner");
    document.getElementById("toast-text").textContent = text || "";
    s.style.display = withSpinner ? "inline-block" : "none";
    t.classList.add("show");
  }
  function hideToast(){
    document.getElementById("app-toast").classList.remove("show");
  }

  function refreshChatList(){
    const list = document.getElementById("chat-list");
    list.innerHTML = "";
    Object.entries(chats).forEach(([id,chat])=>{
      const item = document.createElement("div");
      item.className = "chat-item" + (id===currentChatId ? " active": "");
      item.onclick = () => switchChat(id);
      const title = document.createElement("div");
      title.textContent = chat.title || "æ–°å°è©±";
      const sub = document.createElement("span");
      sub.className = "sub";
      const firstU = chat.history?.[0]?.[0] || "";
      sub.textContent = firstU ? ("ã€Œ"+firstU.slice(0,18)+"ã€") : (chat.isSummary ? "ï¼ˆç¸½æ•´ï¼‰" : "");
      item.appendChild(title);
      if (sub.textContent) item.appendChild(sub);
      list.appendChild(item);
    });
  }

  function newChat(){
    const id = uuid();
    chats[id] = { title:"æ–°å°è©±", history:[] };
    currentChatId = id;
    saveChats();
    refreshChatList();
    renderHistory();
    updateDownloadButton();
  }

  function deleteChat(){
    if (!currentChatId) return;
    if (!confirm("ç¢ºå®šåˆªé™¤æ­¤å°è©±ï¼Ÿ")) return;
    delete chats[currentChatId];
    const keys = Object.keys(chats);
    currentChatId = keys[0] || null;
    saveChats();
    refreshChatList();
    renderHistory();
    updateDownloadButton();
  }

  function switchChat(id){
    currentChatId = id;
    refreshChatList();
    renderHistory();
    updateDownloadButton();
  }

  function renderHistory(){
    chatBox.innerHTML = "";
    const hist = chats[currentChatId]?.history || [];
    if (hist.length === 0) {
      appendMessage("è«‹è¼¸å…¥å•é¡Œï¼Œä¸Šæ–¹å¯åˆ‡æ›æŸ¥è©¢é¡å‹ï¼ˆå…¨éƒ¨ / æ•¸æ“š / è³‡è¨Šï¼‰ã€‚","bot");
      return;
    }
    hist.forEach(([u,a,sources])=>{
      appendMessage(u,"user");
      appendMessage(a,"bot", sources);
    });
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function appendMessage(text, sender, sources = []){
    const msg = document.createElement("div");
    msg.classList.add("message", sender);

    if (sender === "bot" && window.marked && window.DOMPurify) {
      const clean = normalizeMd(text);
      const html = marked.parse(clean, { mangle:false, headerIds:false });
      msg.innerHTML = DOMPurify.sanitize(html);
    } else {
      msg.textContent = text;
    }

    if (sender === "bot" && Array.isArray(sources) && sources.length) {
      const src = document.createElement("div");
      src.className = "source";
      src.textContent = "ä¾†æºï¼š" + sources.join("ã€");
      msg.appendChild(src);
    }

    chatBox.appendChild(msg);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function setMode(m){
    mode = m;
    document.getElementById("btn-all").classList.toggle("active", m==="all");
    document.getElementById("btn-esg").classList.toggle("active", m==="esg");
    document.getElementById("btn-news").classList.toggle("active", m==="news");
    appendMessage(`å·²åˆ‡æ›æ¨¡å¼ï¼š${m==="esg"?"æ•¸æ“šï¼ˆESGï¼‰":m==="news"?"è³‡è¨Šï¼ˆNEWSï¼‰":"å…¨éƒ¨"}`,"bot");
  }

  async function ensureChatTitle(chatId, firstUserMsg){
    if (!chats[chatId]) return;
    if (chats[chatId].title && chats[chatId].title !== "æ–°å°è©±") return;
    try{
      const res = await fetch(TITLE_API, {
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ first_user: firstUserMsg })
      });
      const data = await res.json();
      const title = (data.title || firstUserMsg.slice(0,14)).trim() || "æ–°å°è©±";
      chats[chatId].title = title;
      saveChats(); refreshChatList();
    }catch(e){}
  }

  async function sendMessage(){
    const q = userInput.value.trim();
    if (!q || !currentChatId) return;

    appendMessage(q,"user");
    userInput.value = "";
    sendBtn.disabled = true; sendBtn.textContent = "æ€è€ƒä¸­â€¦";

    const hist = chats[currentChatId]?.history || [];

    try {
      const res = await fetch(API_URL, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ question: q, history: hist.map(([u,a])=>[u,a]), mode })
      });
      if (!res.ok) {
        const t = await res.text();
        throw new Error(`HTTP ${res.status}: ${t.slice(0,200)}`);
      }
      const data = await res.json();
      const answer  = data.answer || "(ç„¡å›è¦†)";
      const sources = Array.isArray(data.sources) ? data.sources : [];

      appendMessage(answer, "bot", sources);

      hist.push([q, answer, sources]);
      chats[currentChatId].history = hist;

      if (hist.length === 1) {
        await ensureChatTitle(currentChatId, q);
      }

      saveChats(); refreshChatList();
    } catch (err) {
      appendMessage("âŒ éŒ¯èª¤ï¼š" + err.message, "bot");
    } finally {
      sendBtn.disabled = false; sendBtn.textContent = "é€å‡º";
    }
  }

  userInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // ===== ç¸½æ•´ Modal =====
  function openSummaryModal(){
    if (isSummarizing) return;
    const modal = document.getElementById("summary-modal");
    const list  = document.getElementById("summary-list");
    list.innerHTML = "";
    Object.entries(chats).forEach(([id, chat])=>{
      const label = document.createElement("label");
      const cb = document.createElement("input");
      cb.type = "checkbox"; cb.value = id;
      const span = document.createElement("span");
      span.textContent = chat.title || "æ–°å°è©±";
      label.appendChild(cb);
      label.appendChild(span);
      list.appendChild(label);
    });
    modal.style.display = "flex";
  }
  function closeSummaryModal(){
    document.getElementById("summary-modal").style.display = "none";
    // è§£é™¤å¿™ç¢Œæ…‹
    document.getElementById("btn-do-sum").classList.remove("busy");
    document.getElementById("btn-cancel-sum").classList.remove("busy");
  }

  // ===== ç”¢ç”Ÿç¸½çµï¼šä¸å¹²æ“¾èŠå¤©ï¼Œæµ®å‹•æç¤ºï¼Œå®Œæˆå¾Œå»ºç«‹æ–°å°è©± =====
  async function summarizeSelected(){
    if (isSummarizing) return;
    const checked = Array.from(document.querySelectorAll("#summary-list input[type=checkbox]:checked")).map(cb => cb.value);
    if (checked.length === 0) { alert("è«‹è‡³å°‘å‹¾é¸ä¸€å€‹å°è©±"); return; }

    // é˜²é€£é» + Modal æŒ‰éˆ•è®Šå¿™ç¢Œ
    isSummarizing = true;
    document.getElementById("btn-do-sum").classList.add("busy");
    document.getElementById("btn-cancel-sum").classList.add("busy");

    // æ‡¸æµ®æç¤ºï¼šæ­£åœ¨ç¸½çµâ€¦
    showToast("æ­£åœ¨ç¸½çµï¼Œè«‹ç¨å€™â€¦", true);

    const items = checked.map(id => ({
      title:   chats[id]?.title   || "æ–°å°è©±",
      history: (chats[id]?.history || []).map(([u,a]) => [u,a])
    }));

    try{
      const res = await fetch(SUM_API, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ items, mode })
      });
      if (!res.ok) {
        const t = await res.text();
        throw new Error(`HTTP ${res.status}: ${t.slice(0,200)}`);
      }

      const data = await res.json();
      const summaryMd   = data.summary || "(ç„¡æ‘˜è¦)";

      // é—œæ‰ Modal
      closeSummaryModal();

      // å»ºç«‹æ–°å°è©±ï¼ˆå·¦å´æ¸…å–®ï¼‰
      const newId = uuid();
      const title = `ç¸½æ•´ - ${fmtNow()}`;
      chats[newId] = {
        title,
        history: [[ "", summaryMd, [] ]],   // ç¬¬ä¸€å‰‡è¨Šæ¯åªæœ‰ botï¼ˆå‰ç«¯æ¸²æŸ“æ™‚æœƒåš user/botä¸€çµ„ï¼Œå› æ­¤ userç•™ç©ºï¼‰
        isSummary: true
      };
      saveChats();

      // åˆ‡æ›åˆ°æ–°å°è©±ä¸¦é¡¯ç¤º
      currentChatId = newId;
      refreshChatList();
      renderHistory();
      updateDownloadButton();

      // çŸ­æç¤ºï¼šå®Œæˆ
      document.getElementById("toast-text").textContent = "âœ… ç¸½çµå®Œæˆ";
      document.querySelector("#app-toast .spinner").style.display = "none";
      setTimeout(hideToast, 1200);

    }catch(err){
      document.getElementById("toast-text").textContent = "âŒ ç¸½çµå¤±æ•—ï¼š" + err.message;
      document.querySelector("#app-toast .spinner").style.display = "none";
      // 3 ç§’å¾Œè‡ªå‹•é—œé–‰
      setTimeout(hideToast, 3000);
    } finally {
      isSummarizing = false;
      document.getElementById("btn-do-sum").classList.remove("busy");
      document.getElementById("btn-cancel-sum").classList.remove("busy");
    }
  }

  // åªåœ¨ç¸½æ•´èŠå¤©é¡¯ç¤ºã€Œä¸‹è¼‰ PDFã€æŒ‰éˆ•
  function updateDownloadButton(){
    const show = !!(currentChatId && chats[currentChatId]?.isSummary);
    dlBtn.style.display = show ? "inline-block" : "none";
  }

  // ä¸‹è¼‰ç›®å‰å°è©±ï¼ˆchat-boxï¼‰ç‚º PDFï¼šhtml2canvas â†’ jsPDFï¼ˆä¸­æ–‡ä¸äº‚ç¢¼ï¼‰
  // å–å¾—ç›®å‰ç¸½æ•´èŠå¤©å®¤çš„ Markdownï¼ˆå¯å¤šæ®µï¼‰
function getCurrentSummaryMarkdown(){
  const chat = chats[currentChatId];
  if (!chat || !chat.isSummary) return null;
  // å°‡è©²ç¸½æ•´å°è©±ä¸­æ‰€æœ‰ bot è¨Šæ¯ä¸²åœ¨ä¸€èµ·ï¼ˆé€šå¸¸åªæœ‰ä¸€æ®µï¼‰
  const parts = (chat.history || [])
    .map(([u,a]) => (a || "").trim())
    .filter(Boolean);
  return parts.join("\n\n---\n\n");
}

// ä¸‹è¼‰ã€Œå…§å®¹æœ¬èº«ã€ç‚º PDFï¼šæŠŠ Markdown æ¸²æŸ“åˆ°éš±è—å€å¡Šï¼Œå†ç”¨ html2canvas åˆ†é è¼¸å‡º
async function downloadSummaryContentPDF(){
  const md = getCurrentSummaryMarkdown();
  if (!md){
    alert("æ‰¾ä¸åˆ°ç¸½æ•´å…§å®¹ã€‚è«‹ç¢ºèªä½ ç›®å‰æ‰€åœ¨çš„æ˜¯ã€Œç¸½æ•´ã€å°è©±ã€‚");
    return;
  }

  // 1) å»ºç«‹éš±è—çš„ä¹¾æ·¨å…§å®¹å€å¡Šï¼ˆä¸å¸¶èŠå¤©æ¨£å¼ï¼‰
  const tmp = document.createElement("div");
  tmp.id = "print-only-summary";
  Object.assign(tmp.style, {
    position: "fixed", left: "-99999px", top: "0",
    width: "794px",      // è¿‘ä¼¼ A4 å¯¬åº¦ï¼ˆptâ†’px çš„ç°¡åŒ–å°æ‡‰ï¼‰
    padding: "24px 28px",
    background: "#ffffff",
    color: "#111",
    lineHeight: "1.6",
    fontFamily: '"Noto Sans TC", system-ui, -apple-system, Segoe UI, Roboto, Arial, "PingFang TC", "Microsoft JhengHei", sans-serif',
    fontSize: "14px"
  });

  // ç°¡å–®çš„ã€Œå…§å®¹ç‰ˆã€æ¨£å¼
  const style = document.createElement("style");
  style.textContent = `
    #print-only-summary h1{font-size:20px;margin:.2em 0 .4em;}
    #print-only-summary h2{font-size:18px;margin:.2em 0 .4em;}
    #print-only-summary h3{font-size:16px;margin:.2em 0 .3em;}
    #print-only-summary p{margin:.4em 0;}
    #print-only-summary ul{margin:.35em 0 .35em 1.2em; padding:0;}
    #print-only-summary li{margin:.2em 0;}
    #print-only-summary code, #print-only-summary pre{
      background:#f6f8fa; border-radius:6px; padding:2px 4px;
    }
    #print-only-summary pre{
      padding:10px; overflow:auto;
    }
    #print-only-summary hr{border:none; border-top:1px solid #e5e7eb; margin:.8em 0;}
  `;
  document.head.appendChild(style);

  // æ¸²æŸ“ Markdown â†’ ä¹¾æ·¨ HTML
  const html = DOMPurify.sanitize(marked.parse(md, {mangle:false, headerIds:false}));
  tmp.innerHTML = html;
  document.body.appendChild(tmp);

  try{
    // 2) è½‰æˆå¤§åœ–ï¼ˆä¿è­‰ä¸­æ–‡å­—ä¸äº‚ç¢¼ï¼‰
    const canvas = await html2canvas(tmp, {
      scale: window.devicePixelRatio > 1 ? window.devicePixelRatio : 2,
      useCORS: true,
      backgroundColor: "#ffffff"
    });

    // 3) åˆ†é è¼¸å‡ºåˆ° A4 PDFï¼ˆç›´å¼ï¼‰
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ unit: "pt", format: "a4" });

    const pageWidth  = pdf.internal.pageSize.getWidth();   // 595pt
    const pageHeight = pdf.internal.pageSize.getHeight();  // 842pt

    const marginX = 40, marginY = 40;
    const imgWidth = pageWidth - marginX*2;
    const scale = imgWidth / canvas.width;
    const imgHeight = canvas.height * scale;

    // ç”¨åˆ‡ç‰‡æ–¹å¼åˆ†é 
    const pageCanvas = document.createElement("canvas");
    const ctx = pageCanvas.getContext("2d");

    let printHeightLeft = imgHeight;
    let srcY = 0;
    let pageIndex = 0;

    while (printHeightLeft > 0) {
      const pagePrintableHeight = pageHeight - marginY*2;          // å–®é å¯ç”¨é«˜åº¦
      const sliceHeightOnImage  = Math.min(printHeightLeft, pagePrintableHeight); // ä»¥ PDF é«˜åº¦å°æ‡‰çš„é¡¯ç¤ºé«˜åº¦
      const sliceHeightOnCanvas = Math.floor(sliceHeightOnImage / scale);         // æ›å›åŸå§‹ç•«å¸ƒä¸Šçš„é«˜åº¦

      pageCanvas.width  = canvas.width;
      pageCanvas.height = sliceHeightOnCanvas;

      ctx.clearRect(0,0,pageCanvas.width,pageCanvas.height);
      ctx.drawImage(
        canvas,
        0, srcY, canvas.width, sliceHeightOnCanvas,    // Source
        0, 0, pageCanvas.width, pageCanvas.height      // Dest
      );

      const pageImg = pageCanvas.toDataURL("image/png");
      if (pageIndex > 0) pdf.addPage();
      pdf.addImage(pageImg, "PNG", marginX, marginY, imgWidth, sliceHeightOnImage);

      srcY += sliceHeightOnCanvas;
      printHeightLeft -= sliceHeightOnImage;
      pageIndex++;
    }

    const now = new Date();
    const fname = `ESG_ç¸½æ•´å…§å®¹_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,"0")}${String(now.getDate()).padStart(2,"0")}.pdf`;
    pdf.save(fname);
  } finally {
    // æ¸…ç†æš«å­˜ DOM / æ¨£å¼
    tmp.remove();
    style.remove();
  }
}

  // ===== åˆå§‹åŒ– =====
  (function init(){
    if (Object.keys(chats).length === 0) {
      newChat();
    } else {
      currentChatId = Object.keys(chats)[0];
      refreshChatList();
      renderHistory();
      updateDownloadButton();
    }
  })();
</script>
</body>
</html>
